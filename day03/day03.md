March 27, 2023 

å­¦ä¹ å¹¶æµ‹è¯•äº†Linuxçš„epollæ¨¡å‹åï¼Œå†³å®šå­¦ä¹ ä¸€ä¸‹Windowsçš„IOCPæ¨¡å‹~

> é¦–å…ˆç®€å•è¯´ä¸€ä¸‹ epoll å’Œ kqueue è¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œå…¶å®ç›¸å·®çš„å¹¶ä¸å¤§ï¼ŒAPI åç§°ä¸ä¸€æ ·ï¼Œè¿˜æœ‰ä¸€äº›è§¦å‘çš„è¡Œä¸ºç»†èŠ‚ä¸ä¸€æ ·ï¼Œä½†æ€»çš„æ¥è¯´éƒ½æ˜¯åœ¨ç¼“å†²åŒºæœ‰å†…å®¹æ—¶è§¦å‘äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆepoll çš„ ET è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼‰ï¼Œä½† IOCP æ˜¯æäº¤äº‹ä»¶ï¼Œäº‹ä»¶å¤„ç†å®Œæˆåï¼ˆè¯»å–æˆ–å‘é€ä¸€å®šçš„å­—èŠ‚æ•°ï¼‰æ‰è§¦å‘äº‹ä»¶ã€‚
> 
1. **Windows IOCPæ¨¡å‹**

> å®Œæˆç«¯å£å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªå…¬å…±æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå®Œæˆç«¯å£æŠŠè¿™äº›è¯·æ±‚åŠ å…¥å…¶æŠ½è±¡å‡ºçš„å…¬å…±æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¸€è¿‡ç¨‹ä¸å¤šä¸ªå·¥ä½œçº¿ç¨‹è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—å¹¶ä»ä¸­å–å‡ºæ¶ˆæ¯åŠ ä»¥å¤„ç†æ˜¯å¹¶å‘æ“ä½œã€‚è¿™ç§æ–¹å¼å¾ˆå¥½åœ°å®ç°äº†å¼‚æ­¥é€šä¿¡å’Œè´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºå®ƒä½¿å‡ ä¸ªçº¿ç¨‹â€œå…¬å¹³åœ°â€å¤„ç†å¤šå®¢æˆ·ç«¯çš„I/Oï¼Œå¹¶ä¸”çº¿ç¨‹ç©ºé—²æ—¶ä¼šè¢«æŒ‚èµ·ï¼Œä¸ä¼šå ç”¨CPUå‘¨æœŸã€‚
> 

> IOCPæ¨¡å‹å……åˆ†åˆ©ç”¨Windowsç³»ç»Ÿå†…æ ¸ï¼Œå¯ä»¥å®ç°ä»…ç”¨å°‘é‡çš„å‡ ä¸ªçº¿ç¨‹æ¥å¤„ç†å’Œå¤šä¸ªclientä¹‹é—´çš„æ‰€æœ‰é€šä¿¡ï¼Œæ¶ˆé™¤äº†æ— è°“çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å¤§é™åº¦çš„æé«˜äº†ç½‘ç»œé€šä¿¡çš„æ€§èƒ½ã€‚
> 

<aside>
ğŸ’¡ IOCPçš„ä½¿ç”¨ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

</aside>

- è°ƒç”¨`CreateIoCompletionPort`å‡½æ•°ï¼Œåˆ›å»ºå®Œæˆç«¯å£(iocp)å¯¹è±¡
- åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œåœ¨å®Œæˆç«¯å£ä¸Šæ‰§è¡Œå¹¶å¤„ç†æŠ•é€’åˆ°å®Œæˆç«¯å£ä¸Šçš„I/Oè¯·æ±‚
- Socketå…³è”iocpå¯¹è±¡ï¼Œåœ¨Socketä¸ŠæŠ•é€’ç½‘ç»œäº‹ä»¶
- å·¥ä½œçº¿ç¨‹è°ƒç”¨`GetQueuedCompletionStatus`å‡½æ•°è·å–å®Œæˆé€šçŸ¥å°åŒ…ï¼Œå–å¾—äº‹ä»¶ä¿¡æ¯å¹¶è¿›è¡Œå¤„ç†

[Windowsä¸‹çš„IOCPæ¨¡å‹ï¼ˆä¸€ï¼‰ï¼šä»‹ç»ä¸ç®€å•ä½¿ç”¨_Summer_night_starçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/Summer_night_star/article/details/120803104)

[Windows ä¸‹ IOCP çš„ç®€å•ä½¿ç”¨](https://zhuanlan.zhihu.com/p/544666070)

1. **WSAï¼šWindows Sockets Asynchronous**

<aside>
ğŸ’¡ **socketä¸WSASocketçš„åŒºåˆ«**

socket()å‡½æ•°åˆ›å»ºä¸€ä¸ªé€šè®¯èŠ‚ç‚¹å¹¶è¿”å›ä¸€ä¸ªå¥—æ¥å­—ï¼Œå¦‚æœæ˜¯é˜»å¡å¥—æ¥å­—æ—¶ï¼Œç›¸åº”apiä¼šé˜»å¡ã€‚

WSASocket()çš„å‘é€æ“ä½œå’Œæ¥æ”¶æ“ä½œéƒ½å¯ä»¥è¢«é‡å ä½¿ç”¨ï¼Œæ¥æ”¶å‡½æ•°å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œå‘é€å‡½æ•°ä¹Ÿå¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œç»„æˆä¸€ä¸ªå‘é€ç¼“å†²åŒºé˜Ÿåˆ—ï¼Œsocket()å´åªèƒ½å‘è¿‡ä¹‹åç­‰å¾…å›æ¶ˆæ¯æ‰å¯åšä¸‹ä¸€æ­¥æ“ä½œã€‚

</aside>

1. **å¤šçº¿ç¨‹ç›¸å…³**

[C++ threadç”¨æ³•æ€»ç»“(æ•´ç†)_é¡ºå…¶è‡ªç„¶~çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/fuhanghang/article/details/114818215)

### å®éªŒ

å®ç°äº†ä½¿ç”¨IOCPï¼ˆIOå®Œæˆç«¯å£ï¼‰æ¥æ”¶äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨äº†å•ä¸ªå·¥ä½œçº¿ç¨‹å¤„ç†äº‹ä»¶ï¼ˆreadäº‹ä»¶ï¼‰ã€‚

é¦–å…ˆä½¿ç”¨`WSASocketW`å‡½æ•°åˆ›å»ºå¥—æ¥å­—ï¼Œå¹¶ç»‘å®šåœ°å€ï¼š

```bash
# server
D:\Projects-my\cpp_study\cppServer\CppServer-Win\day03>.\iocp
WSASocketW: 172, IP: 127.0.0.1, port: 8080
```

åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œåˆ›å»ºå¥—æ¥å­—å¹¶ç»‘å®šåœ°å€ï¼š

```bash
# client
D:\Projects-my\cpp_study\cppServer\CppServer-Win\day03>.\client
server WSAStartup success
client socket 252 connect to 127.0.0.1, port: 8080
```

åœ¨å®¢æˆ·ç«¯è¾“å…¥`hello`åç¨‹åºé€€å‡ºï¼ŒæœåŠ¡ç«¯åˆå§‹åŒ–å·¥ä½œçº¿ç¨‹å’Œæ¥æ”¶è¿›ç¨‹ã€‚

æ¥æ”¶è¿›ç¨‹å°†æ¥æ”¶å¥—æ¥å­—ç»‘å®šåˆ°IOCPï¼Œå¹¶æäº¤ä¸€æ¬¡è¯»å–äº‹ä»¶ï¼›

å·¥ä½œçº¿ç¨‹è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œè¿›è¡Œå¤„ç†ã€‚

```bash
# serveræ¥æ”¶åˆ°"hello"
read bytes: 1024
hello
type any to quit...
```

æœ€åé”®å…¥ä»»æ„å­—ç¬¦é€€å‡ºï¼Œå‘æ‰€æœ‰å·¥ä½œçº¿ç¨‹å‘é€é€€å‡ºæŒ‡ä»¤ï¼Œç¨‹åºç»“æŸã€‚

March 25, 2023 

## Linux epoll

ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹

1. epolléœ€è¦ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥å”¯ä¸€æ ‡è¯†å†…æ ¸ä¸­çš„è¿™ä¸ªäº‹ä»¶è¡¨ï¼š

```cpp
#includeï¼œsys/epoll.hï¼
int epoll_create(int size)
// è¯¥å‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å°†ç”¨ä½œå…¶ä»–æ‰€æœ‰epollç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥æŒ‡å®šè¦è®¿é—®çš„å†…æ ¸äº‹ä»¶è¡¨ã€‚
```

[epoll_create1ä¸epoll_createåŒºåˆ« - æå…†é¾™çš„åšå®¢ - åšå®¢å›­](https://www.cnblogs.com/lizhaolong/p/16437375.html)

epollç›‘å¬äº‹ä»¶çš„æè¿°ç¬¦ä¼šæ”¾åœ¨ä¸€é¢—çº¢é»‘æ ‘ä¸Š

[å›¾è§£ï¼šä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿ](https://zhuanlan.zhihu.com/p/273829162)

1. æ“ä½œepollçš„å†…æ ¸äº‹ä»¶è¡¨

```cpp
#includeï¼œsys/epoll.hï¼
int epoll_ctl(int epfd,int op,int fd,struct epoll_event*event)
// epoll_ctlæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚
```

epoll_eventçš„å®šä¹‰å¦‚ä¸‹ï¼š

```cpp
struct epoll_event
{
__uint32_t events;/*epolläº‹ä»¶*/
epoll_data_t data;/*ç”¨æˆ·æ•°æ®*/
};
```

epoll_data_tæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå…¶4ä¸ªæˆå‘˜ä¸­ä½¿ç”¨æœ€å¤šçš„æ˜¯fdï¼Œå®ƒæŒ‡å®šäº‹ä»¶æ‰€ä»å±çš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ã€‚

[æ·±å…¥ç†è§£Cè¯­è¨€ä¹‹unionï¼ˆå…±ç”¨ä½“ï¼‰å’Œç»“æ„ä½“struct_unionç»“æ„ä½“_å°ç°ä¿ çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/weixin_41040351/article/details/118701770)

1. epoll_waitå‡½æ•°

```cpp
#include <sys/epoll.h>
epoll_wait(int epfd, struct epoll_event*events, int maxevents, int timeout)
// æˆåŠŸæ—¶è¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚
```

> epoll_waitå‡½æ•°å¦‚æœæ£€æµ‹åˆ°äº‹ä»¶ï¼Œå°±å°†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ä»å†…æ ¸äº‹ä»¶è¡¨ï¼ˆç”±epfdå‚æ•°æŒ‡å®šï¼‰ä¸­å¤åˆ¶åˆ°å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°eventsæŒ‡å‘çš„æ•°ç»„ä¸­ã€‚è¿™ä¸ªæ•°ç»„åªç”¨äºè¾“å‡ºepoll_waitæ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶ï¼Œè€Œä¸åƒselectå’Œpollçš„æ•°ç»„å‚æ•°é‚£æ ·æ—¢ç”¨äºä¼ å…¥ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶ï¼Œåˆç”¨äºè¾“å‡ºå†…æ ¸æ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶ã€‚
> 
1. LTå’ŒET

> epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLTï¼ˆLevel Triggerï¼Œç”µå¹³è§¦å‘ï¼‰æ¨¡å¼å’ŒETï¼ˆEdge Triggerï¼Œè¾¹æ²¿è§¦å‘ï¼‰æ¨¡å¼ã€‚
> 

LTæ¨¡å¼æ˜¯é»˜è®¤çš„å·¥ä½œæ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹epollç›¸å½“äºä¸€ä¸ªæ•ˆç‡è¾ƒé«˜çš„pollã€‚

å½“å¾€epollå†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„EPOLLETäº‹ä»¶æ—¶ï¼Œepollå°†ä»¥ETæ¨¡å¼æ¥æ“ä½œè¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚ETæ¨¡å¼æ˜¯epollçš„é«˜æ•ˆå·¥ä½œæ¨¡å¼ã€‚

å½“epoll_waitæ£€æµ‹åˆ°å…¶ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºåï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ï¼Œå› ä¸º**åç»­çš„epoll_waitè°ƒç”¨å°†ä¸å†å‘åº”ç”¨ç¨‹åºé€šçŸ¥è¿™ä¸€äº‹ä»¶ã€‚**

### å®éªŒ

è¿è¡Œserverï¼Œå¹¶å¦å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œè¿è¡Œä¸¤ä¸ªclientï¼Œå¯ä»¥çœ‹åˆ°serverç«¯æ˜¾ç¤ºè¿æ¥ä¸Šäº†ä¸¤ä¸ªclient fdï¼š

```bash
zxy@xd:~/cppServer/30dayMakeCppServer-main/code/day03$ ./server
new client fd 5! IP: 127.0.0.1 Port: 54000
new client fd 6! IP: 127.0.0.1 Port: 38472
```

åˆ†åˆ«ä»å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œå¯è§æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸¤ä¸ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼š

```bash
# client1
1123
message from server: 1123
# client2
2123
message from server: 2123
# server
message from client fd 5: 1123
finish reading once, errno: 11
message from client fd 6: 2123
finish reading once, errno: 11
```

æ–­å¼€å®¢æˆ·ç«¯1åï¼ŒæœåŠ¡ç«¯æ˜¾ç¤º

```bash
# client1
^C
# server
EOF, client fd 5 disconnected
```

æ­¤æ—¶å®¢æˆ·ç«¯2ä¾ç„¶ä¸æœåŠ¡ç«¯è¿æ¥ï¼Œå¯ä»¥æ­£å¸¸æ”¶å‘æ¶ˆæ¯ï¼š

```bash
# client2
2234
message from server: 2234
# server
message from client fd 6: 2234
finish reading once, errno: 11
```